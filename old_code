
<div class="fb_invite_friends">
  <%= form_tag('/fb_app_invite', id:"fb_invite_friends") %>
    <%= hidden_field_tag :current_user, @me["username"] %>
    <%= hidden_field_tag :invitees, nil, id:"invitees" %>
    <div class="invitees">
      <%= label_tag :invitees %></br>
      <%= text_area_tag :show_invitees, nil, id:"show_invitees", readonly: true, class:"required" %>
    </div>
    <div class="subject_message">
      <p>
        <%= label_tag :subject %></br>
        <%= text_field_tag :subject, nil, class:"required" %>
      </p>
      <p>
        <%= label_tag :message %></br>
        <%= text_area_tag :message, nil, class:"required" %>
      </p>
    </div>
    <div class="submit">
      <%= submit_tag "Send", class:"btn btn-rsvp btn-fb-invite" %>
    </div>
</div>

// INVITE => INVITED IN FIND FRIENDS
  $(".invite").click(
    function() {
        username = $(this).attr('alt');
        name = $(this).attr('name');
        if ($('#show_invitees').text().length == 0) {
        $('#invitees').attr('value', username);
        $('#show_invitees').text(name);
      }
        else {
        usernames = $('#invitees').attr('value');
        $('#invitees').attr('value', usernames + ", " + username);
        $('#show_invitees').append(", " + name);
      }
        $(this).removeClass('btn-success');
        $(this).addClass('btn_stop_viewing');
    });

keyup

class UserSearch
  constructor: ->
    @lastEvent = undefined
    @timer = undefined
    @oldValue = undefined
    $('#btn_user_search').on('click', @performSearch)
    $('#user_search_field').on('keyup', @setEventTimer)
    $('body').on('click', @checkHideResults)
    $('#search_form').on 'submit', ->
      return false

  checkHideResults: (e) =>
    window.target = e
    unless $(e.target).closest('#search_results').length || $(e.target).attr('id') == 'user_search_field' || $(e.target).attr('id') == 'btn_user_search'
      @hideResults()

  hideResults: ->
    $('#search_results').remove()
    $('#user_search_field').val('')
    $('.search_spinner').css({'background-position': 'right 21900915389012px'})

  setEventTimer: =>
    if $('#user_search_field').val().length == 0
      @hideResults()

    if $('#user_search_field').val().length > 1 # and $('#user_search_field').val() != @oldValue
      clearTimeout(@timer)
      @timer = setTimeout(@performSearch, 700)
      $('.search_spinner').css({'background-position': 'right'})
    @oldValue = $('#user_search_field').val()

  performSearch: (e) =>
    e?.preventDefault()
    $.ajax
      url: window.location
      success: -> 
        $('.search_spinner').css({'background-position': 'right 2000000px'})
      data:
        'search': $('#user_search_field').val()

$ ->
  new UserSearch() if $('#user_search_field').length




#OAUTH METHOD
  # def self.find_for_facebook_oauth(auth, signed_in_resource=nil)
  #   user = User.where(:provider => auth.provider, :uid => auth.uid).first
  #   unless user
  #     user = User.create(  name:auth.extra.raw_info.name,
  #                          provider:auth.provider,
  #                          uid:auth.uid,
  #                          email:auth.info.email,
  #                          password:Devise.friendly_token[0,20],
  #                          terms: 't',
  #                          city:auth.info.location
  #                          )
  #   end
  #   user
  # end

# https://github.com/pantulis/devise-omniauth-only-twitter/blob/master/app/models/user.rb

  # has_many :authentications
  
  # def self.find_for_twitter_oauth(omniauth)
  #   authentication = Authentication.find_by_provider_and_uuid(omniauth['provider'], omniauth['uid'])
  #   if authentication && authentication.user
  #     authentication.user
  #   else
  #     user = User.create!(:nickname => omniauth['nickname'], 
  #                           :name => omniauth['name'])
  #     user.authentications.create!(:provider => omniauth['provider'], :uuid => omniauth['uid'])
  #     user.save
  #     user
  #   end
  # end


FB events

upon sign up from facebook (omniauth_controller)
add method create_fb_events

in events model:

  def create_fb_events

    @graph.get_connections("me", "events")
    @graph.get_connections("me", "invitations")?

    [{"name"=>"Housewarming Party",
  "start_time"=>"2012-08-25T14:00:00-0500",
  "end_time"=>"2012-08-25T22:00:00-0500",
  "timezone"=>"America/Chicago",
  "location"=>"8954 Sunstone Ln Middleton, WI 53562",
  "id"=>"316821768413401",
  "rsvp_status"=>"attending"}]


  create dummy facebook user

  call asynchronously to get the events and invites 
    on each
      Check that they have start TIME
      if true
      Check on fb_id if events are already there
      if false
      determin the event's owner & privacy
        @graph.get_object("415061778552519")
        lookup host from hi's users by fb_id
        if present - create event with user as host and visibility
        else - create event with set fb_dummy is host and visibility
      create net new events and either RSVP or invite the user (if the events have start times)
  end

    create job to check at night if users should replace fb_dummy
      get all events from facebook using fb_event_id
      If owner = current_user && current owner = fb_dummy
        Then replace fb_dummy with current_user as owner of event

    # @plans = self.plans
    # @date_plans = []
    # @plans.each do |p|
    #   if p.starts_at.to_date == load_date
    #     p.inviter_id = p.user.id
    #     @date_plans.push(p)
    #   end
    # end

    # @date_invited_events = []
    # self.invitations.each do |i|
    #   e = Event.find_by_id(i.invited_event_id)
    #   if e.starts_at.to_date == load_date
    #     unless self.rsvpd?(e)
    #       e.inviter_id = i.inviter_id
    #       @date_invited_events.push(e)
    #     end
    #   end
    # end



  # def forecastoverview
  #   @forecastoverview = []
  #   (-3..16).each do |i|
  #     if self.time_zone
  #       @new_date = Time.now.in_time_zone(self.time_zone).to_date + i
  #     else
  #       @new_date = Date.today + i
  #     end
  #     @datecounts = []
      
  #     @ideacount = self.idea_count_on_date(@new_date)
  #     @plancount = self.plan_count_on_date(@new_date)
  #     @datecounts.push(@ideacount)
  #     @datecounts.push(@plancount)
  #     @forecastoverview.push(@datecounts)
  #   end
  #   return @forecastoverview
  # end

  # #these could be maintained on RSVP/unRSVP... maybe
  # def plan_count_on_date(load_date)
  #   @plancount = 0
  #   self.plans.each do |p|
  #     if p.starts_at.to_date == load_date
  #       @plancount = @plancount + 1
  #     end
  #   end
  #   return @plancount
  # end

  # def idea_count_on_date(load_date)
  #   @ideacount = 0

  #   @invitations = Invite.where('invites.email = :current_user_email', current_user_email: self.email)
  #   @invitations.each do |i|
  #     @ie = Event.find_by_id(i.event_id)
  #     if @ie.starts_at.to_date == load_date
  #       unless self.rsvpd?(@ie)
  #         @ideacount = @ideacount + 1
  #       end
  #     end
  #   end

  #   self.followed_users.each do |f|
  #     f.plans.each do |fp| #for friends of friends events that are RSVPd for
  #       if fp.starts_at.to_date == load_date
  #         unless fp.visibility == "invite_only" || self.rsvpd?(fp) || self.invited?(fp)
  #           if fp.user == f || fp.visibility == "friends_of_friends"
  #             @ideacount = @ideacount + 1
  #           end
  #         end
  #       end
  #     end
  #   end
  #   return @ideacount
  # end

_plans.html.erb
<div id='datepicker'>
  <%= render partial: 'shalendar/datepicker' %>
</div>

<div id='yt'><a href='#<%= Time.now.to_date %>' id='todayButton' class='btn-today'>Today</a></div>

<div class="home" id="scrollContainer">
<% for i in -3..26 %>
  <div class="each_day persist-area clearfix">    
    <div class="date_bar marker persist-header clearfix shield <% if i == 0 %> red <% end %>" <% if i == 0 %> id="today" <% end %> data-date=<%= "#{Time.now.to_date + i}" %>>
      <div class="date"><%= (Time.now.to_date + (i)).strftime("%A %b %e") %></div>
    </div>
    <div class="day_container clearfix">
      <div class="idea_container clearfix">
        <% if @ideas[i + 3].any? %>
          <% @ideas[i + 3].each do |e| %>
            <%= render :partial => "shalendar/event", :locals => { :event => e } %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
</div>


    <% if false %>
      <li>
        <%= link_to post_to_own_fb_wall_path(:event_id => @event.id), class:"fadeInFBBlue" , confirm:"Post idea to your wall?", title:"Post to Facebook", remote: true do %>
          <i class="icon-facebook-sign"></i>
        <% end %>
      </li>
    <% end %>

    <!--     <li>
      <a href="https://twitter.com/share" 
        data-url="<%= event_url(@event) %>"
        data-via="hoos_in"
        data-size="large" 
        data-count="none" 
        class="fadeInTwitter" 
        title="<%= @event.title %> #hoosin" 
        target="_blank">
        <i class="icon-twitter"></i>
      </a>
    </li> -->


    <% if @event.guests_can_invite_friends? && !@event.short_url.nil? %>
      <li id="textMsg">
        <a href="sms:?body=<%= url_encode(@event.title + " - " + @event.short_url) %>"><span class="fadeInOrange"><i class="icon-phone"></i></span></a>
      </li> 
    <% end %> 


    Event#show
        <% if false %>
    <div class="host friend">
      <%= link_to user_path(@event.user), target: "blank" do %>
        <%= raster_profile_picture(@event.user) %> 
      <% end %>
      <div>hosted by: </div><br>
      <% if !user_signed_in? || (current_user.following?(@event.user) || current_user == @event.user) %>
        <div>
          <%= @event.user.name %>
        </div>
      <% else %>
        <div id="friend_name">
          <%= @event.user.name %>
        </div>
        <div id="friend_button" style="display:none;">
          <%= render  :partial => 'events/just_follow_form', :locals => { :user => @event.user } %>
        </div>
      <% end %>
    </div>
    <% end %>



          <% if false %>    
        <% if event.starts_at.hour > 4 && event.starts_at.hour < 12 %>
          <%= image_tag "morning.png" %>
        <% elsif event.starts_at.hour >= 12 && event.starts_at.hour < 18 %>
          <%= image_tag "noon.png" %>
        <% else %>
          <%= image_tag "night.png" %>
        <% end %>
      <% end %>



      
<% if false %>
      <% if event.user == current_user && event.tipped? == false && event.tipped? == true %>
        <div class="force_tip">
          <%= link_to raw("&#xf08d;"), tip_path(:event_id => event.id), :confirm => "Tip this idea? This cannot be reversed and will send notifications to all RSVPs.", :method => :put, :title => "Tip this Idea", :class => "fa-input", remote:true, id:"tipPin" %>
        </div>
      <% end %>
    <% unless event.is_public? %>
      <% unless event.user == User.find_by_id(event.inviter_id) %>
        <div class="host">by: <%= event.user.first_name.capitalize %> 
          <% if event.user.last_name %>
            <%= event.user.last_name.capitalize%>
          <% end %> 
        </div>
      <% end %>
    <% end %>
<% end %>


    <% if event.starts_at.present? %>
      <% if event.tipped? %>  
        <div class="meter">
          <span style="width:100%;"><span></span></span>
        </div>
      <% elsif event.starts_at.present?%>
        <div class="meter animate orange">
          <span style=<%= 'width:' + "#{(100*event.guest_count.to_f/event.min.to_f).round}" + "%;"%>><span></span></span>
        </div>
      <% end %>
    <% end %>



      <div class="right_header">
    <div>
      
    </div>
    <div>
    <ul>
      <li id="jrActivity">
        <%= link_to user_path(current_user) do %>
          <span class="fadeInBlue">
            <%= current_user.events.count %> <i class="icon-cloud"></i> 
            <span id="headerText">mine</span>
          </span>
        <% end %>
      </li>
      <li id="jrFriends">
        <a href="<%= manage_friends_path %>"> 
          <span class="fadeInGreen">
            <strong id="header_friend_count" class="friend_count"><%= current_user.followers.count %></strong> <i class="icon-group"></i>
            <span id="headerText">friends</span></span>
          <% if current_user.reverse_relationships.where('relationships.confirmed = false').any? %>
          <% @friend_requests = current_user.reverse_relationships.where('relationships.confirmed = false') %>
            <span class="new_friends_count"><%= @friend_requests.count %></span>
          <% end %>
        </a>
      </li>
      <% if false %>
      <li id="jrInvites">
        <%= link_to new_invited_events_path, :remote => true do %>
          <% unless current_user.new_invited_events_count == 0 %>
            <span id="new_invited_events_count" class="new_invited_events_count"><%= current_user.new_invited_events_count %></span>
          <% end %>
          <span class="fadeInPurple">
            <%= current_user.invitations.count %> <i class="icon-envelope" title=".invites"></i>
            <!-- <span id="headerText">.invites</span> -->
          </span>
        <% end %>
      </li>
      <li>
        <%= link_to plans_path, :remote => true do %>
          <% if current_user.plans.where('ends_at > ?', Time.now).any? %>
            <span class="fadeInPurple">
              <%= current_user.plans.where('ends_at > ?', Time.now).count %> <i class="icon-envelope-alt" title=".ins"></i>
              <!-- <span id="headerText">.ins</span> -->
            </span>
          <% else %> 
            <span class="fadeInPurple">
              0 <i class="icon-envelope-alt" title=".ins"></i>
              <!-- <span id="headerText">.ins</span> -->
            </span>         
          <% end %>
        <% end %>
      </li>
      <% end %>
      <% if current_user.admin? %>
      <li>
        <%= link_to admin_dashboard_path do %>
          <span class="fadeInRed"><i class="icon-magic"></i></span>
        <% end %>
      </li>
      <% end %>
    </ul>
  </div>
</div>
  </div>


  , :dir => "rtl" 



    <span id="auth-status" class="fb_button fb_login_button">
    <a href="#" id="auth-loginlink" class="fb-login-button"><span class="btn_fb_login"></span></a>
  </span>


  <% if false %>
  <% if event.tipped? %>  
    <div class="meter">
      <span style="width:100%;"><span></span></span>
    </div>
  <% elsif event.starts_at.present?%>
    <div class="meter animate orange">
      <span style=<%= 'width:' + "#{(100*event.guest_count.to_f/event.min.to_f).round}" + "%;"%>><span></span></span>
    </div>
  <% end %>
<% end %>
          <% if false %>
          <span id="jrIdeas" class="bold">all</span> |
          <span id="jrMine"><span class="hide_on_mobile"> <%= @mine.count %></span> mine</span> |
          <span id="jrCityIdeas"><span class="hide_on_mobile"> <%= @city_ideas.count %></span> public</span> ||
          <span id="jrCalendar"><i class="icon-calendar"></i> <span class="hide_on_mobile"> view</span></span>
          <% end %>


          <% if false %>
<div id="timesCalendar" style="display:none;">
  <%= render "shalendar/calendar" %>
</div>

<div id="ideaFilter" class="idea_filter"
<% if params[:action] == "home" %>
<div id="ideaFilter" class="idea_filter">
  all
</div>
<% end %>
<% end %>

  <div class="facepile">
    <span id="guestCount"><%= event.guest_count %> <%= user_signed_in? ? '(' + "#{event.friends_in_count(current_user)}" + ')' : '' %></span>
    <% event.guests.each do |guest| %>
      <span title="<%= guest.name %>"><%= raster_profile_picture(guest) %></span>
    <% end %>
  </div>



<% if false %>
    <div class="venue_invitation_options" id="visibilityp" style="display:none;">
      <div class="idea_categories" id="addcategoriesp" style="display:none;">
        <%= label :category, "Category*" %>
        <div id="categories">
          <%= collection_select :category, :category_id, Category.all, :id, :name, { :prompt => true } %>
        </div>
        <div class="family_friendly_checkbox">
          <%= f.label "Family Friendly?" %><br>
          <i class="icon-home questionMark"></i>
          <%= f.check_box :family_friendly, class: "switch" %>
        </div> 
      </div> 
    </div>
<% end %>

            <li>
              <%= link_to event, method: :delete, data: { confirm: 'Are you sure you want to cancel this time? This will notify all guests.' }, class: "fadeInRed" do %>
                <i class="icon-trash"></i>
              <% end %>
            </li>



$('#invitations').html("<%= escape_javascript(render partial: 'shalendar/new_invited_events') %>");
$('#overlay').fadeToggle();

$('body').click(function() {
  $('.invited_events').fadeOut();
  $('#new_invited_events_count').text('0').fadeOut();
  $('#overlay').fadeOut();
});

$('.invited_events').click(function(event){
     event.stopPropagation();
 });

$('.invited_events').children().click(function(event){
     event.stopPropagation();
 });

$("a[href$='new_invited_events']").click(function(event){
     event.stopPropagation();
     $('#new_invited_events_count').text('0').hide();
 });

$("a[href$='new_invited_events']").click(function(e) {
    $('#new_invited_events_count').text('0').hide();
    e.preventDefault();
    $('.invited_events').fadeToggle();
    $('#overlay').fadeToggle();
  });

$('.idea_container').imagesLoaded( function(){
   $('.idea_container').masonry({
     itemSelector : '.shield',
     isAnimated: true,
   animationOptions: {
     duration: 200
   }
   });
 });
